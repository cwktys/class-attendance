<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班級到達操場管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // 🔥 請將下面的設定改為您從Firebase複製的設定
        const firebaseConfig = {
            apiKey: "AIzaSyAqLitpQ-W2EFVJb5ytlh_fFaXEfGdsOns",
            authDomain: "classroom-tracker-demo.firebaseapp.com",
            databaseURL: "ttps://classroom-tracker-demo-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "classroom-tracker-demo",
            storageBucket: "classroom-tracker-demo.firebasestorage.app",
            messagingSenderId: "889652567824",
            appId: "1:889652567824:web:e9017d7dc072b0c8624f95"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // 讓其他腳本可以使用 database
        window.database = database;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbOnValue = onValue;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .arrived {
            animation: pulse 2s ease-in-out;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .status-badge {
            transition: all 0.3s ease;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
        }

        .connected {
            background-color: #10B981;
            color: white;
        }

        .disconnected {
            background-color: #EF4444;
            color: white;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <!-- 連線狀態指示 -->
    <div id="connectionStatus" class="connection-status disconnected">
        🔴 離線
    </div>

    <div class="container mx-auto px-2 py-4 max-w-7xl">
        <!-- 標題區域 -->
        <div class="text-center mb-4">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-2">
                班級到達操場管理
            </h1>
            <p class="text-gray-600 dark:text-gray-300 text-base">
                點擊班級按鈕來標記到達狀態 - 即時同步
            </p>
        </div>

        <!-- 統計資訊 -->
        <div class="grid grid-cols-3 gap-2 md:gap-4 mb-4">
            <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-3 text-center">
                <div class="text-xl font-bold text-blue-600 dark:text-blue-400" id="totalClasses">0</div>
                <div class="text-blue-800 dark:text-blue-300 text-xs">總班級數</div>
            </div>
            <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-3 text-center">
                <div class="text-xl font-bold text-green-600 dark:text-green-400" id="arrivedClasses">0</div>
                <div class="text-green-800 dark:text-green-300 text-xs">已到達</div>
            </div>
            <div class="bg-orange-50 dark:bg-orange-900/30 rounded-lg p-3 text-center">
                <div class="text-xl font-bold text-orange-600 dark:text-orange-400" id="pendingClasses">0</div>
                <div class="text-orange-800 dark:text-orange-300 text-xs">未到達</div>
            </div>
        </div>

        <!-- 控制按鈕 -->
        <div class="flex gap-2 justify-center mb-4">
            <button onclick="resetAll()" 
                    class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors duration-200 text-sm">
                重置全部
            </button>
            <button onclick="markAllArrived()" 
                    class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-colors duration-200 text-sm">
                全部到達
            </button>
        </div>

        <!-- 尚未到達班級警示區 -->
        <div id="pendingAlert" class="mb-4">
            <!-- 將由 JavaScript 動態生成 -->
        </div>

        <!-- 班級列表 -->
        <div class="grid grid-cols-4 gap-2 md:gap-3" id="classGrid">
            <!-- 班級卡片將由 JavaScript 動態生成 -->
        </div>
    </div>

    <script>
        // 深色模式檢測
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // 班級資料
        const classes = [
            { id: 'class1A', name: '1A', grade: 1 },
            { id: 'class1B', name: '1B', grade: 1 },
            { id: 'class1C', name: '1C', grade: 1 },
            { id: 'class1D', name: '1D', grade: 1 },
            { id: 'class2A', name: '2A', grade: 2 },
            { id: 'class2B', name: '2B', grade: 2 },
            { id: 'class2C', name: '2C', grade: 2 },
            { id: 'class2D', name: '2D', grade: 2 },
            { id: 'class3A', name: '3A', grade: 3 },
            { id: 'class3B', name: '3B', grade: 3 },
            { id: 'class3C', name: '3C', grade: 3 },
            { id: 'class3D', name: '3D', grade: 3 }
        ];

        // 班級狀態
        let classStatus = {};
        let isFirebaseReady = false;

        // 等待 Firebase 初始化
        function waitForFirebase() {
            if (window.database) {
                isFirebaseReady = true;
                setupFirebaseListeners();
                updateConnectionStatus(true);
                loadDataFromFirebase();
            } else {
                setTimeout(waitForFirebase, 100);
            }
        }

        // 設置 Firebase 監聽器
        function setupFirebaseListeners() {
            const statusRef = window.dbRef(window.database, 'classStatus');
            window.dbOnValue(statusRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    classStatus = data;
                    renderClasses();
                }
            });
        }

        // 從 Firebase 載入資料
        async function loadDataFromFirebase() {
            try {
                const statusRef = window.dbRef(window.database, 'classStatus');
                const snapshot = await window.dbGet(statusRef);
                if (snapshot.exists()) {
                    classStatus = snapshot.val();
                } else {
                    // 如果沒有資料，初始化預設狀態
                    initializeClasses();
                    await saveToFirebase();
                }
                renderClasses();
            } catch (error) {
                console.error('載入資料失敗:', error);
                updateConnectionStatus(false);
                initializeClasses();
                renderClasses();
            }
        }

        // 儲存到 Firebase
        async function saveToFirebase() {
            if (!isFirebaseReady) return;
            try {
                const statusRef = window.dbRef(window.database, 'classStatus');
                await window.dbSet(statusRef, classStatus);
            } catch (error) {
                console.error('儲存失敗:', error);
                updateConnectionStatus(false);
            }
        }

        // 更新連線狀態顯示
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = '🟢 已連線';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = '🔴 離線';
            }
        }

        // 初始化班級狀態
        function initializeClasses() {
            classes.forEach(cls => {
                classStatus[cls.id] = false;
            });
        }

        // 創建班級卡片
        function createClassCard(cls) {
            const isArrived = classStatus[cls.id];
            
            return `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden border ${isArrived ? 'border-green-500' : 'border-gray-200 dark:border-gray-700'}">
                    <div class="p-3">
                        <div class="text-center mb-3">
                            <h3 class="text-sm font-semibold text-gray-800 dark:text-white mb-1">
                                ${cls.name}
                            </h3>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getGradeColor(cls.grade)}">
                                ${cls.grade}年級
                            </span>
                        </div>
                        
                        <div class="mb-3 text-center">
                            <span class="status-badge inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${isArrived ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'}">
                                ${isArrived ? '✅ 已到達' : '⏳ 未到達'}
                            </span>
                        </div>
                        
                        <button onclick="toggleClassStatus('${cls.id}')" 
                                class="w-full px-3 py-2 rounded-lg font-medium transition-all duration-200 text-sm ${isArrived ? 'bg-orange-500 hover:bg-orange-600 text-white' : 'bg-primary hover:bg-primary/90 text-white'}">
                            ${isArrived ? '標記未到達' : '標記已到達'}
                        </button>
                    </div>
                </div>
            `;
        }

        // 獲取年級顏色
        function getGradeColor(grade) {
            const colors = {
                1: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400',
                2: 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400',
                3: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400'
            };
            return colors[grade] || 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
        }

        // 渲染班級列表
        function renderClasses() {
            const classGrid = document.getElementById('classGrid');
            classGrid.innerHTML = classes.map(cls => createClassCard(cls)).join('');
            updateStatistics();
        }

        // 切換班級狀態
        async function toggleClassStatus(classId) {
            classStatus[classId] = !classStatus[classId];
            
            // 立即更新UI
            renderClasses();
            
            // 儲存到 Firebase
            await saveToFirebase();
        }

        // 重置全部
        async function resetAll() {
            Object.keys(classStatus).forEach(classId => {
                classStatus[classId] = false;
            });
            renderClasses();
            await saveToFirebase();
        }

        // 標記全部到達
        async function markAllArrived() {
            Object.keys(classStatus).forEach(classId => {
                classStatus[classId] = true;
            });
            renderClasses();
            await saveToFirebase();
        }

        // 更新統計資訊
        function updateStatistics() {
            const total = classes.length;
            const arrived = Object.values(classStatus).filter(status => status).length;
            const pending = total - arrived;

            document.getElementById('totalClasses').textContent = total;
            document.getElementById('arrivedClasses').textContent = arrived;
            document.getElementById('pendingClasses').textContent = pending;
            
            updatePendingAlert();
        }

        // 更新尚未到達班級警示區
        function updatePendingAlert() {
            const pendingAlertDiv = document.getElementById('pendingAlert');
            const pendingClasses = classes.filter(cls => !classStatus[cls.id]);
            
            if (pendingClasses.length === 0) {
                pendingAlertDiv.innerHTML = `
                    <div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 rounded-lg p-4 text-center">
                        <div class="flex items-center justify-center mb-2">
                            <span class="text-2xl mr-2">🎉</span>
                            <span class="text-lg font-semibold text-green-800 dark:text-green-300">全部班級已到達！</span>
                        </div>
                        <p class="text-green-600 dark:text-green-400 text-sm">所有班級都已安全到達操場</p>
                    </div>
                `;
            } else {
                const pendingList = pendingClasses.map(cls => 
                    `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400 mx-1 mb-2">
                        ${cls.name}
                    </span>`
                ).join('');
                
                pendingAlertDiv.innerHTML = `
                    <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-lg p-4">
                        <div class="flex items-center mb-3">
                            <span class="text-2xl mr-2">🚨</span>
                            <span class="text-lg font-semibold text-red-800 dark:text-red-300">尚未到達的班級</span>
                            <span class="ml-2 px-2 py-1 text-xs font-bold bg-red-600 text-white rounded-full">
                                ${pendingClasses.length}
                            </span>
                        </div>
                        <div class="flex flex-wrap">
                            ${pendingList}
                        </div>
                    </div>
                `;
            }
        }

        // 初始化應用
        function initApp() {
            updateConnectionStatus(false);
            initializeClasses();
            renderClasses();
            waitForFirebase();
        }

        // 啟動應用
        initApp();
    </script>
</body>
</html>